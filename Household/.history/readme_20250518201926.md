# 家政小程序需求文档

## 1. 项目概述

本项目旨在开发一款家政服务小程序，连接用户、家政服务商家和家政服务师傅，提供便捷的在线预约、管理和统计功能。

## 2. 角色与功能

### 2.1 用户端

- **浏览服务**：查看不同类型的家政服务（如保洁、月嫂、维修等）及商家信息。
- **在线下单**：
  - 智能时间选择：可视化日历+时段选择
  - 地址智能识别：支持地图定位/手动输入自动补全
  - 电话自动格式化：实时验证 11 位手机号格式
  - 商家/师傅选择：基于位置和时间的智能推荐
  - 订单预览：标准化展示时间/地址/联系方式
  - 安全支付：集成微信支付接口
- **订单管理**：
  - 查看订单状态（待确认、已确认、进行中、已完成、已取消）。
  - **取消订单**：
    - 用户可以发起取消订单请求。
    - 师傅需要确认取消请求。如果师傅在规定时间内未确认，订单状态不变或按预设规则处理（例如，自动取消但有相应提示）。
    - 如果师傅同意取消，订单状态更新为“已取消”，并处理退款（如果适用）。
    - 如果师傅不同意取消（例如，已出发或已准备物料），订单无法取消，用户会收到相应提示。
  - **修改订单时间**：
    - 用户可以发起修改订单时间请求。
    - 师傅需要确认新的时间。如果师傅在规定时间内未确认，订单时间不变或按预设规则处理。
    - 如果师傅同意修改时间，订单预约时间更新。
    - 如果师傅不同意修改时间（例如，新时间段已有安排），订单时间无法修改，用户会收到相应提示。
  - **重要提示**：如果用户发起的取消或改时间请求，师傅在规定时间内未响应或明确拒绝，则该订单视为“报废”或进入待处理状态，需要管理员介入或按平台规则处理。小程序界面需明确提示用户此风险。
- **评价与反馈**：对完成的服务进行评价。
- **个人中心**：管理个人信息、优惠券、常用地址等。

### 2.2 商家端

- **商家入驻**：提交资质信息，等待平台审核。
- **服务管理**：发布、编辑、上下架家政服务项目，设置价格、服务范围等。
- **师傅管理**：
  - 邀请或添加师傅信息。
  - 分配订单给名下师傅。
  - 查看师傅接单情况和状态。
- **订单管理**：
  - 查看本店所有订单状态。
  - 处理用户订单（例如，确认订单，指派师傅）。
- **数据统计**：
  - **今日订单统计**：
    - 成功下单数量。
    - 用户取消订单数量（需区分师傅同意取消和因师傅未响应/拒绝导致的报废订单）。
    - 用户修改订单时间数量（需区分师傅同意修改和因师傅未响应/拒绝导致的未修改订单）。
  - 收入统计、用户增长等。
- **财务管理**：查看结算信息、提现等。

### 2.3 师傅端

- **师傅入驻/绑定**：接受商家邀请或自行注册，提交个人信息及技能认证，等待平台/商家审核。
- **服务定价管理**：
  - 设置基础服务价格（需符合平台定价规则）
  - 参与竞价订单时可调整报价（±20%范围内）
  - 查看历史报价成功率分析
- **订单接收与管理**：
  - 接收智能派单（价格优先匹配）或抢单池接单
  - 查看订单详情（服务内容、时间、地点、用户要求、当前竞价排名）
  - **确认/拒绝用户取消请求**：及时响应用户的取消订单申请。
  - **确认/拒绝用户改时间请求**：及时响应用户的修改订单时间申请。
  - 更新服务状态（如已出发、服务中、已完成）。
- **数据统计**：
  - **今日接单统计**：
    - 总接单数量（区分智能派单和抢单）
    - 竞价成功率（报价被采纳比例）
    - 成功完成订单数量。
    - 失败/取消订单数量（需区分用户取消且师傅同意、用户取消但师傅未响应/拒绝、师傅主动取消等情况）。
  - **价格竞争力分析**：
    - 同类服务平均报价
    - 本师傅报价分布
    - 不同报价区间接单成功率
  - **可提现金额**：根据平台结算规则计算。
- **个人中心**：管理个人信息、服务范围、日程安排等。
- **财务管理**：查看收入明细、申请提现。

### 2.4 管理员端 (平台后台)

- **用户管理**：查看用户信息、处理用户申诉。
- **商家管理**：审核商家入驻申请、管理商家信息、处理商家违规。
- **师傅管理**：审核师傅资质、管理师傅信息、处理师傅违规。
- **订单管理**：监控平台所有订单、处理异常订单（如用户取消/改时间师傅未响应导致的报废订单）、介入纠纷。
- **服务类目管理**：管理平台提供的家政服务类型。
- **内容管理**：发布公告、活动信息等。
- **协调群聊管理**：
  - 查看进行中的协调群聊
  - 下载群聊记录
  - 设置自动建群规则
- **数据统计与分析**：平台整体运营数据，如总订单量、交易额、用户增长、活跃度等。
- **财务管理**：处理平台结算、退款等。
- **系统设置**：
  - 配置竞价规则（报价浮动范围、响应时限等）
  - 设置智能派单算法权重（价格占比 60%、评分占比 30%、响应速度占比 10%）
  - 配置平台基础规则（取消/改时响应时限、报废订单处理逻辑等）
  - 费率设置

## 3. 核心业务逻辑

### 3.1 用户下单流程

1.  用户选择服务 -> 选择商家/师傅（可选）-> 选择服务时间 -> 确认订单信息 -> 支付。
2.  订单生成后进入派单流程：
    - **智能派单模式**（默认）：
      1. 系统根据师傅报价（价格从低到高排序）
      2. 结合服务质量评分（≥4 星）
      3. 优先推送给性价比最高的 3 位师傅
      4. 最先响应的师傅获得订单
    - **抢单模式**：订单进入抢单池，所有符合条件的师傅可在指定时间内报价
3.  接单师傅确认订单详情，订单状态变为“已确认/待服务”。
4.  若 15 分钟无师傅接单，自动转人工派单并通知商家。

### 3.2 用户取消订单逻辑

**时间限制规则**：

- 距离服务开始时间 ≥8 小时：用户可无责取消（平台全额退款）
- 距离服务开始时间<8 小时：
  - 用户不可主动取消
  - 若因不可抗力需取消：
    1. 需提供有效证明（医疗证明/紧急情况证明）
    2. 支付师傅 50%服务费作为补偿
    3. 平台重新分配其他师傅

1.  用户在允许时间范围内发起取消请求。
2.  对应师傅收到取消请求通知。
3.  **师傅处理**：
    - **同意取消**：订单状态变为“已取消”，系统处理退款（若已支付）。
    - **拒绝取消**：订单状态不变，用户收到拒绝通知及原因。
    - **超时未处理**：若师傅在规定时间内未响应，系统将自动创建包含用户、客服、相关师傅和商家的协调群聊，订单按平台预设规则处理（例如，视为“报废”，通知管理员介入，或自动同意取消但标记师傅响应不及时）。小程序需明确告知用户此种情况的后果。

### 3.3 用户修改订单时间逻辑

**时间限制规则**：

- 距离服务开始时间 ≥8 小时：
  - 用户可免费修改 1 次
  - 后续每次修改需支付 10%服务费作为调度费
- 距离服务开始时间<8 小时：
  - 仅允许因客观原因修改（需上传凭证）
  - 每次修改需支付 30%服务费
  - 师傅拒绝修改需书面说明原因

1.  用户在允许时间范围内发起修改时间请求，并选择新的期望时间。
2.  对应师傅收到修改时间请求通知。
3.  **师傅处理**：
    - **同意修改**：订单预约时间更新为新时间，订单状态可能相应更新（如仍为“已确认/待服务”）。
    - **拒绝修改**：订单时间不变，用户收到拒绝通知及原因（如新时间段不可用）。
    - **超时未处理**：若师傅在规定时间内未响应，订单按平台预设规则处理（例如，视为“报废”，通知管理员介入，或视为修改失败）。小程序需明确告知用户此种情况的后果。

### 3.4 "报废"订单处理

**新增条款**：

1. 师傅责任条款：

   - 因病取消需三甲医院电子病历+视频验证
   - 每月首次免责，后续每次扣 50%订单金额
   - 虚假病假将永久封号

2. 协调群聊机制：

   - 自动显示脱敏电话（格式：138\*\*\*\*5678）
   - 群内可发起多方视频验证
   - 聊天记录自动生成调解备忘录

3. 费用结算规则：
   - 用户 8 小时内强制取消：支付 100%费用
   - 师傅虚假病假：双倍返还用户支付金额
   - 自然因素报废：平台承担 50%损失

- **自动建群机制**：

  - 触发条件：
    1. 用户取消/改时间请求被师傅拒绝
    2. 师傅超时未响应请求
    3. 订单进入"报废"状态
  - 群聊功能：
    - 支持文字、图片、语音消息
    - 显示用户/商家/师傅基本信息
    - 客服可上传调解协议文件
  - 记录保存：
    - 聊天记录自动关联订单编号
    - 保存至平台数据库至少 180 天
    - 各方可查看历史沟通记录

- 当用户取消或改时间请求因师傅未在规定时间内响应或明确拒绝，导致订单无法按用户意愿进行时，该订单可被标记为"报废"或进入"待协调"状态。
- 平台应有明确机制处理此类订单，具体处理逻辑如下：
  - **用户取消订单但师傅未同意/未响应**：
    - 订单标记为"报废"，但平台仍需支付师傅费用。
    - 系统自动记录此类情况，并纳入师傅响应率统计。
    - 通知管理员介入协调，确认师傅未响应的原因。
    - 向用户说明订单状态及费用处理方式。
  - **用户在 8 小时内申请改时间但师傅未同意/未响应**：
    - 师傅应配合用户修改时间（平台规则要求）。
    - 若师傅未在规定时间内响应，系统记录此情况，并可能影响师傅的评级。
    - 管理员介入协调新的服务时间。
  - 根据平台规则自动判定责任方和后续处理（如是否退款、是否对师傅有相应处罚等）。
  - 清晰告知用户订单的最终状态和处理结果。

## 4. 数据统计需求

### 4.1 商家数据统计

- **实时数据**：
  - 8 小时内/外取消订单数
  - 8 小时内/外改时间请求数
  - 今日成功下单数。
  - 今日用户发起取消并成功的订单数。
  - 今日用户发起取消但失败/报废的订单数。
  - 今日用户发起改时间并成功的订单数。
  - 今日用户发起改时间但失败/报废的订单数。
- **历史数据**：可按日、周、月查询上述数据，以及总收入、客单价等。

## 4. 数据统计需求

### 4.2 师傅数据统计

- **实时数据**：
  - 病假取消订单数
  - 8 小时临界点响应及时率
  - 今日总接单数（区分智能派单/抢单）。
  - 实时竞价排名（当前订单报价对比）。
  - 今日成功完成订单数。
  - 今日失败/取消订单数（细分原因：用户取消师傅同意、用户取消师傅拒绝/超时、师傅取消等）。
- **价格分析**：
  - 历史报价成功率曲线
  - 不同报价区间接单比例
  - 最优报价建议（基于历史数据）
- **财务数据**：
  - 当前可提现金额。
  - 累计收入。
  - 提现记录。
- **历史数据**：可按日、周、月查询接单量、完成率、报价趋势等。

### 4.3 平台数据统计 (管理员后台)

- 用户增长趋势、活跃用户数。
- 商家增长趋势、各商家订单量排行。
- 师傅增长趋势、各师傅接单量/好评率排行。
- 平台总订单量、总交易额、平均订单价值。
- 各类服务订单占比。
- 取消订单率、改时间请求率及其处理成功率。
- “报废”订单数量及原因分析。

## 5. 非功能性需求

- **易用性**：界面简洁直观，操作流程顺畅。
- **性能**：小程序加载速度快，订单处理、数据统计响应及时。
- **可靠性**：系统稳定，数据准确，订单状态同步无误。
- **安全性**：保障用户信息、交易数据安全，符合相关法律法规要求。
- **兼容性**：兼容主流微信版本和手机操作系统。
- **可扩展性**：方便未来增加新的服务类型或功能模块。

## 6. 技术栈建议 (可选)

- **小程序端**：微信原生小程序框架或 Taro/uni-app 等多端框架。
- **服务端**：Node.js (Express/Koa/NestJS), Java (Spring Boot), Python (Django/Flask), Go 等。
- **数据库**：MySQL, PostgreSQL, MongoDB 等。
- **缓存**：Redis。
- **消息队列**：RabbitMQ, Kafka (用于订单状态变更通知等异步处理)。

### 6.2 数据存储与显示

**数据库字段设计**：

```
formatted_time DATETIME NOT NULL COMMENT 'ISO8601格式时间'
structured_address JSON NOT NULL COMMENT '结构化的地址信息（包含省/市/区/街道/门牌号/坐标）'
normalized_phone VARCHAR(20) NOT NULL COMMENT 'E.164标准格式电话号码'
```

**数据显示规范**：

1. 商家/师傅端显示：
   - 时间："3 月 15 日 周四 14:30-15:00"
   - 地址："北京市朝阳区 XX 路 XX 号"（省市区三级精简显示）
   - 电话："138\*\*\*\*5678"（隐私保护格式）
2. 后台管理系统显示：
   - 完整坐标信息（经纬度）
   - 原始输入记录（用于纠纷追溯）
3. 数据导出格式：
   - 时间列：YYYY-MM-DD HH:mm:ss
   - 地址列：三级行政区划单独列（省/市/区）

## 7. 后续迭代方向 (可选)

- 优惠券、促销活动功能。
- 会员体系。
- 地图定位与导航功能。
- 在线客服/IM 功能。
- 家政知识、技巧分享社区。

- 自动建群触发次数（按纠纷类型分类）
- 群聊平均解决时长
- 群聊解决成功率
- 客服响应时效统计
